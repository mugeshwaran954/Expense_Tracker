<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="text-primary-dark mb-0"><i class="fas fa-chart-pie me-2"></i>Dashboard</h2>
  <div>
    <a href="/expenses/add" class="btn btn-primary">
      <i class="fas fa-plus me-2"></i>Add Expense
    </a>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-7">
    <div class="card shadow-lg h-100">
      <div class="card-header">
        This Month's Spending by Category
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="expenseChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-lg h-100">
      <div class="card-header">
        <i class="fas fa-list me-2"></i>Recent Expenses
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead>
              <tr>
                <th class="ps-3">Date</th>
                <th>Category</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody>
              <% if (expenses.length === 0) { %>
                <tr>
                  <td colspan="3" class="text-center text-muted p-4">No expenses found.</td>
                </tr>
              <% } else { %>
                <% expenses.forEach(exp => { %>
                  <tr>
                    <td class="ps-3"><%= exp.formatted_date %></td>
                    <td><%= exp.category %></td>
                    <td>$<%= Number(exp.amount).toFixed(2) %></td>
                  </tr>
                <% }) %>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Get data from EJS
  const chartData = <%- JSON.stringify(chartData) %>;
  const labels = chartData.map(d => d.category);
  const data = chartData.map(d => d.total);

  // New color palette
  const chartColors = [
    '#5b2eae', '#8a4ff7', '#c285ff', '#d9b3ff', '#f0e5ff',
    '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff'
  ];

  const ctx = document.getElementById('expenseChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        label: 'Expenses ($)',
        data: data,
        backgroundColor: chartColors,
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false, // <-- This is key for the container to work
      plugins: {
        legend: {
          position: 'bottom',
          labels: { 
            color: '#222', 
            font: { size: 14, family: 'Inter' } 
          }
        }
      }
    }
  });
</script>

<%- include('partials/footer') %>